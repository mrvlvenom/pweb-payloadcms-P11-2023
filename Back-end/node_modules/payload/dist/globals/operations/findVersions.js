"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return _default;
    }
});
const _executeAccess = /*#__PURE__*/ _interop_require_default(require("../../auth/executeAccess"));
const _combineQueries = require("../../database/combineQueries");
const _validateQueryPaths = require("../../database/queryValidation/validateQueryPaths");
const _afterRead = require("../../fields/hooks/afterRead");
const _commitTransaction = require("../../utilities/commitTransaction");
const _initTransaction = require("../../utilities/initTransaction");
const _killTransaction = require("../../utilities/killTransaction");
const _sanitizeInternalFields = /*#__PURE__*/ _interop_require_default(require("../../utilities/sanitizeInternalFields"));
const _buildGlobalFields = require("../../versions/buildGlobalFields");
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
async function findVersions(args) {
    const { depth, globalConfig, limit, overrideAccess, page, req: { locale, payload }, req, showHiddenFields, sort, where } = args;
    const versionFields = (0, _buildGlobalFields.buildVersionGlobalFields)(globalConfig);
    try {
        const shouldCommit = await (0, _initTransaction.initTransaction)(req);
        // /////////////////////////////////////
        // Access
        // /////////////////////////////////////
        const accessResults = !overrideAccess ? await (0, _executeAccess.default)({
            req
        }, globalConfig.access.readVersions) : true;
        await (0, _validateQueryPaths.validateQueryPaths)({
            globalConfig,
            overrideAccess,
            req,
            versionFields,
            where
        });
        const fullWhere = (0, _combineQueries.combineQueries)(where, accessResults);
        // /////////////////////////////////////
        // Find
        // /////////////////////////////////////
        const paginatedDocs = await payload.db.findGlobalVersions({
            global: globalConfig.slug,
            limit: limit ?? 10,
            locale,
            page: page || 1,
            req,
            sort,
            where: fullWhere
        });
        // /////////////////////////////////////
        // afterRead - Fields
        // /////////////////////////////////////
        let result = {
            ...paginatedDocs,
            docs: await Promise.all(paginatedDocs.docs.map(async (data)=>({
                    ...data,
                    version: await (0, _afterRead.afterRead)({
                        collection: null,
                        context: req.context,
                        depth,
                        doc: data.version,
                        findMany: true,
                        global: globalConfig,
                        overrideAccess,
                        req,
                        showHiddenFields
                    })
                })))
        };
        // /////////////////////////////////////
        // afterRead - Global
        // /////////////////////////////////////
        result = {
            ...result,
            docs: await Promise.all(result.docs.map(async (doc)=>{
                const docRef = doc;
                await globalConfig.hooks.afterRead.reduce(async (priorHook, hook)=>{
                    await priorHook;
                    docRef.version = await hook({
                        context: req.context,
                        doc: doc.version,
                        findMany: true,
                        global: globalConfig,
                        query: fullWhere,
                        req
                    }) || doc.version;
                }, Promise.resolve());
                return docRef;
            }))
        };
        // /////////////////////////////////////
        // Return results
        // /////////////////////////////////////
        result = {
            ...result,
            docs: result.docs.map((doc)=>(0, _sanitizeInternalFields.default)(doc))
        };
        if (shouldCommit) await (0, _commitTransaction.commitTransaction)(req);
        return result;
    } catch (error) {
        await (0, _killTransaction.killTransaction)(req);
        throw error;
    }
}
const _default = findVersions;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9nbG9iYWxzL29wZXJhdGlvbnMvZmluZFZlcnNpb25zLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgUGFnaW5hdGVkRG9jcyB9IGZyb20gJy4uLy4uL2RhdGFiYXNlL3R5cGVzJ1xuaW1wb3J0IHR5cGUgeyBQYXlsb2FkUmVxdWVzdCB9IGZyb20gJy4uLy4uL2V4cHJlc3MvdHlwZXMnXG5pbXBvcnQgdHlwZSB7IFdoZXJlIH0gZnJvbSAnLi4vLi4vdHlwZXMnXG5pbXBvcnQgdHlwZSB7IFR5cGVXaXRoVmVyc2lvbiB9IGZyb20gJy4uLy4uL3ZlcnNpb25zL3R5cGVzJ1xuaW1wb3J0IHR5cGUgeyBTYW5pdGl6ZWRHbG9iYWxDb25maWcgfSBmcm9tICcuLi9jb25maWcvdHlwZXMnXG5cbmltcG9ydCBleGVjdXRlQWNjZXNzIGZyb20gJy4uLy4uL2F1dGgvZXhlY3V0ZUFjY2VzcydcbmltcG9ydCB7IGNvbWJpbmVRdWVyaWVzIH0gZnJvbSAnLi4vLi4vZGF0YWJhc2UvY29tYmluZVF1ZXJpZXMnXG5pbXBvcnQgeyB2YWxpZGF0ZVF1ZXJ5UGF0aHMgfSBmcm9tICcuLi8uLi9kYXRhYmFzZS9xdWVyeVZhbGlkYXRpb24vdmFsaWRhdGVRdWVyeVBhdGhzJ1xuaW1wb3J0IHsgYWZ0ZXJSZWFkIH0gZnJvbSAnLi4vLi4vZmllbGRzL2hvb2tzL2FmdGVyUmVhZCdcbmltcG9ydCB7IGNvbW1pdFRyYW5zYWN0aW9uIH0gZnJvbSAnLi4vLi4vdXRpbGl0aWVzL2NvbW1pdFRyYW5zYWN0aW9uJ1xuaW1wb3J0IHsgaW5pdFRyYW5zYWN0aW9uIH0gZnJvbSAnLi4vLi4vdXRpbGl0aWVzL2luaXRUcmFuc2FjdGlvbidcbmltcG9ydCB7IGtpbGxUcmFuc2FjdGlvbiB9IGZyb20gJy4uLy4uL3V0aWxpdGllcy9raWxsVHJhbnNhY3Rpb24nXG5pbXBvcnQgc2FuaXRpemVJbnRlcm5hbEZpZWxkcyBmcm9tICcuLi8uLi91dGlsaXRpZXMvc2FuaXRpemVJbnRlcm5hbEZpZWxkcydcbmltcG9ydCB7IGJ1aWxkVmVyc2lvbkdsb2JhbEZpZWxkcyB9IGZyb20gJy4uLy4uL3ZlcnNpb25zL2J1aWxkR2xvYmFsRmllbGRzJ1xuXG5leHBvcnQgdHlwZSBBcmd1bWVudHMgPSB7XG4gIGRlcHRoPzogbnVtYmVyXG4gIGdsb2JhbENvbmZpZzogU2FuaXRpemVkR2xvYmFsQ29uZmlnXG4gIGxpbWl0PzogbnVtYmVyXG4gIG92ZXJyaWRlQWNjZXNzPzogYm9vbGVhblxuICBwYWdlPzogbnVtYmVyXG4gIHJlcT86IFBheWxvYWRSZXF1ZXN0XG4gIHNob3dIaWRkZW5GaWVsZHM/OiBib29sZWFuXG4gIHNvcnQ/OiBzdHJpbmdcbiAgd2hlcmU/OiBXaGVyZVxufVxuXG5hc3luYyBmdW5jdGlvbiBmaW5kVmVyc2lvbnM8VCBleHRlbmRzIFR5cGVXaXRoVmVyc2lvbjxUPj4oXG4gIGFyZ3M6IEFyZ3VtZW50cyxcbik6IFByb21pc2U8UGFnaW5hdGVkRG9jczxUPj4ge1xuICBjb25zdCB7XG4gICAgZGVwdGgsXG4gICAgZ2xvYmFsQ29uZmlnLFxuICAgIGxpbWl0LFxuICAgIG92ZXJyaWRlQWNjZXNzLFxuICAgIHBhZ2UsXG4gICAgcmVxOiB7IGxvY2FsZSwgcGF5bG9hZCB9LFxuICAgIHJlcSxcbiAgICBzaG93SGlkZGVuRmllbGRzLFxuICAgIHNvcnQsXG4gICAgd2hlcmUsXG4gIH0gPSBhcmdzXG5cbiAgY29uc3QgdmVyc2lvbkZpZWxkcyA9IGJ1aWxkVmVyc2lvbkdsb2JhbEZpZWxkcyhnbG9iYWxDb25maWcpXG5cbiAgdHJ5IHtcbiAgICBjb25zdCBzaG91bGRDb21taXQgPSBhd2FpdCBpbml0VHJhbnNhY3Rpb24ocmVxKVxuXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEFjY2Vzc1xuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGNvbnN0IGFjY2Vzc1Jlc3VsdHMgPSAhb3ZlcnJpZGVBY2Nlc3NcbiAgICAgID8gYXdhaXQgZXhlY3V0ZUFjY2Vzcyh7IHJlcSB9LCBnbG9iYWxDb25maWcuYWNjZXNzLnJlYWRWZXJzaW9ucylcbiAgICAgIDogdHJ1ZVxuXG4gICAgYXdhaXQgdmFsaWRhdGVRdWVyeVBhdGhzKHtcbiAgICAgIGdsb2JhbENvbmZpZyxcbiAgICAgIG92ZXJyaWRlQWNjZXNzLFxuICAgICAgcmVxLFxuICAgICAgdmVyc2lvbkZpZWxkcyxcbiAgICAgIHdoZXJlLFxuICAgIH0pXG5cbiAgICBjb25zdCBmdWxsV2hlcmUgPSBjb21iaW5lUXVlcmllcyh3aGVyZSwgYWNjZXNzUmVzdWx0cylcblxuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBGaW5kXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgY29uc3QgcGFnaW5hdGVkRG9jcyA9IGF3YWl0IHBheWxvYWQuZGIuZmluZEdsb2JhbFZlcnNpb25zPFQ+KHtcbiAgICAgIGdsb2JhbDogZ2xvYmFsQ29uZmlnLnNsdWcsXG4gICAgICBsaW1pdDogbGltaXQgPz8gMTAsXG4gICAgICBsb2NhbGUsXG4gICAgICBwYWdlOiBwYWdlIHx8IDEsXG4gICAgICByZXEsXG4gICAgICBzb3J0LFxuICAgICAgd2hlcmU6IGZ1bGxXaGVyZSxcbiAgICB9KVxuXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIGFmdGVyUmVhZCAtIEZpZWxkc1xuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGxldCByZXN1bHQgPSB7XG4gICAgICAuLi5wYWdpbmF0ZWREb2NzLFxuICAgICAgZG9jczogYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIHBhZ2luYXRlZERvY3MuZG9jcy5tYXAoYXN5bmMgKGRhdGEpID0+ICh7XG4gICAgICAgICAgLi4uZGF0YSxcbiAgICAgICAgICB2ZXJzaW9uOiBhd2FpdCBhZnRlclJlYWQoe1xuICAgICAgICAgICAgY29sbGVjdGlvbjogbnVsbCxcbiAgICAgICAgICAgIGNvbnRleHQ6IHJlcS5jb250ZXh0LFxuICAgICAgICAgICAgZGVwdGgsXG4gICAgICAgICAgICBkb2M6IGRhdGEudmVyc2lvbixcbiAgICAgICAgICAgIGZpbmRNYW55OiB0cnVlLFxuICAgICAgICAgICAgZ2xvYmFsOiBnbG9iYWxDb25maWcsXG4gICAgICAgICAgICBvdmVycmlkZUFjY2VzcyxcbiAgICAgICAgICAgIHJlcSxcbiAgICAgICAgICAgIHNob3dIaWRkZW5GaWVsZHMsXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pKSxcbiAgICAgICksXG4gICAgfSBhcyBQYWdpbmF0ZWREb2NzPFQ+XG5cbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gYWZ0ZXJSZWFkIC0gR2xvYmFsXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgcmVzdWx0ID0ge1xuICAgICAgLi4ucmVzdWx0LFxuICAgICAgZG9jczogYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIHJlc3VsdC5kb2NzLm1hcChhc3luYyAoZG9jKSA9PiB7XG4gICAgICAgICAgY29uc3QgZG9jUmVmID0gZG9jXG5cbiAgICAgICAgICBhd2FpdCBnbG9iYWxDb25maWcuaG9va3MuYWZ0ZXJSZWFkLnJlZHVjZShhc3luYyAocHJpb3JIb29rLCBob29rKSA9PiB7XG4gICAgICAgICAgICBhd2FpdCBwcmlvckhvb2tcblxuICAgICAgICAgICAgZG9jUmVmLnZlcnNpb24gPVxuICAgICAgICAgICAgICAoYXdhaXQgaG9vayh7XG4gICAgICAgICAgICAgICAgY29udGV4dDogcmVxLmNvbnRleHQsXG4gICAgICAgICAgICAgICAgZG9jOiBkb2MudmVyc2lvbixcbiAgICAgICAgICAgICAgICBmaW5kTWFueTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBnbG9iYWw6IGdsb2JhbENvbmZpZyxcbiAgICAgICAgICAgICAgICBxdWVyeTogZnVsbFdoZXJlLFxuICAgICAgICAgICAgICAgIHJlcSxcbiAgICAgICAgICAgICAgfSkpIHx8IGRvYy52ZXJzaW9uXG4gICAgICAgICAgfSwgUHJvbWlzZS5yZXNvbHZlKCkpXG5cbiAgICAgICAgICByZXR1cm4gZG9jUmVmXG4gICAgICAgIH0pLFxuICAgICAgKSxcbiAgICB9XG5cbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gUmV0dXJuIHJlc3VsdHNcbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICByZXN1bHQgPSB7XG4gICAgICAuLi5yZXN1bHQsXG4gICAgICBkb2NzOiByZXN1bHQuZG9jcy5tYXAoKGRvYykgPT4gc2FuaXRpemVJbnRlcm5hbEZpZWxkczxUPihkb2MpKSxcbiAgICB9XG5cbiAgICBpZiAoc2hvdWxkQ29tbWl0KSBhd2FpdCBjb21taXRUcmFuc2FjdGlvbihyZXEpXG5cbiAgICByZXR1cm4gcmVzdWx0XG4gIH0gY2F0Y2ggKGVycm9yOiB1bmtub3duKSB7XG4gICAgYXdhaXQga2lsbFRyYW5zYWN0aW9uKHJlcSlcbiAgICB0aHJvdyBlcnJvclxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZpbmRWZXJzaW9uc1xuIl0sIm5hbWVzIjpbImZpbmRWZXJzaW9ucyIsImFyZ3MiLCJkZXB0aCIsImdsb2JhbENvbmZpZyIsImxpbWl0Iiwib3ZlcnJpZGVBY2Nlc3MiLCJwYWdlIiwicmVxIiwibG9jYWxlIiwicGF5bG9hZCIsInNob3dIaWRkZW5GaWVsZHMiLCJzb3J0Iiwid2hlcmUiLCJ2ZXJzaW9uRmllbGRzIiwiYnVpbGRWZXJzaW9uR2xvYmFsRmllbGRzIiwic2hvdWxkQ29tbWl0IiwiaW5pdFRyYW5zYWN0aW9uIiwiYWNjZXNzUmVzdWx0cyIsImV4ZWN1dGVBY2Nlc3MiLCJhY2Nlc3MiLCJyZWFkVmVyc2lvbnMiLCJ2YWxpZGF0ZVF1ZXJ5UGF0aHMiLCJmdWxsV2hlcmUiLCJjb21iaW5lUXVlcmllcyIsInBhZ2luYXRlZERvY3MiLCJkYiIsImZpbmRHbG9iYWxWZXJzaW9ucyIsImdsb2JhbCIsInNsdWciLCJyZXN1bHQiLCJkb2NzIiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsImRhdGEiLCJ2ZXJzaW9uIiwiYWZ0ZXJSZWFkIiwiY29sbGVjdGlvbiIsImNvbnRleHQiLCJkb2MiLCJmaW5kTWFueSIsImRvY1JlZiIsImhvb2tzIiwicmVkdWNlIiwicHJpb3JIb29rIiwiaG9vayIsInF1ZXJ5IiwicmVzb2x2ZSIsInNhbml0aXplSW50ZXJuYWxGaWVsZHMiLCJjb21taXRUcmFuc2FjdGlvbiIsImVycm9yIiwia2lsbFRyYW5zYWN0aW9uIl0sIm1hcHBpbmdzIjoiOzs7OytCQXdKQTs7O2VBQUE7OztzRUFsSjBCO2dDQUNLO29DQUNJOzJCQUNUO21DQUNRO2lDQUNGO2lDQUNBOytFQUNHO21DQUNNOzs7Ozs7QUFjekMsZUFBZUEsYUFDYkMsSUFBZTtJQUVmLE1BQU0sRUFDSkMsS0FBSyxFQUNMQyxZQUFZLEVBQ1pDLEtBQUssRUFDTEMsY0FBYyxFQUNkQyxJQUFJLEVBQ0pDLEtBQUssRUFBRUMsTUFBTSxFQUFFQyxPQUFPLEVBQUUsRUFDeEJGLEdBQUcsRUFDSEcsZ0JBQWdCLEVBQ2hCQyxJQUFJLEVBQ0pDLEtBQUssRUFDTixHQUFHWDtJQUVKLE1BQU1ZLGdCQUFnQkMsSUFBQUEsMkNBQXdCLEVBQUNYO0lBRS9DLElBQUk7UUFDRixNQUFNWSxlQUFlLE1BQU1DLElBQUFBLGdDQUFlLEVBQUNUO1FBRTNDLHdDQUF3QztRQUN4QyxTQUFTO1FBQ1Qsd0NBQXdDO1FBRXhDLE1BQU1VLGdCQUFnQixDQUFDWixpQkFDbkIsTUFBTWEsSUFBQUEsc0JBQWEsRUFBQztZQUFFWDtRQUFJLEdBQUdKLGFBQWFnQixNQUFNLENBQUNDLFlBQVksSUFDN0Q7UUFFSixNQUFNQyxJQUFBQSxzQ0FBa0IsRUFBQztZQUN2QmxCO1lBQ0FFO1lBQ0FFO1lBQ0FNO1lBQ0FEO1FBQ0Y7UUFFQSxNQUFNVSxZQUFZQyxJQUFBQSw4QkFBYyxFQUFDWCxPQUFPSztRQUV4Qyx3Q0FBd0M7UUFDeEMsT0FBTztRQUNQLHdDQUF3QztRQUV4QyxNQUFNTyxnQkFBZ0IsTUFBTWYsUUFBUWdCLEVBQUUsQ0FBQ0Msa0JBQWtCLENBQUk7WUFDM0RDLFFBQVF4QixhQUFheUIsSUFBSTtZQUN6QnhCLE9BQU9BLFNBQVM7WUFDaEJJO1lBQ0FGLE1BQU1BLFFBQVE7WUFDZEM7WUFDQUk7WUFDQUMsT0FBT1U7UUFDVDtRQUVBLHdDQUF3QztRQUN4QyxxQkFBcUI7UUFDckIsd0NBQXdDO1FBRXhDLElBQUlPLFNBQVM7WUFDWCxHQUFHTCxhQUFhO1lBQ2hCTSxNQUFNLE1BQU1DLFFBQVFDLEdBQUcsQ0FDckJSLGNBQWNNLElBQUksQ0FBQ0csR0FBRyxDQUFDLE9BQU9DLE9BQVUsQ0FBQTtvQkFDdEMsR0FBR0EsSUFBSTtvQkFDUEMsU0FBUyxNQUFNQyxJQUFBQSxvQkFBUyxFQUFDO3dCQUN2QkMsWUFBWTt3QkFDWkMsU0FBUy9CLElBQUkrQixPQUFPO3dCQUNwQnBDO3dCQUNBcUMsS0FBS0wsS0FBS0MsT0FBTzt3QkFDakJLLFVBQVU7d0JBQ1ZiLFFBQVF4Qjt3QkFDUkU7d0JBQ0FFO3dCQUNBRztvQkFDRjtnQkFDRixDQUFBO1FBRUo7UUFFQSx3Q0FBd0M7UUFDeEMscUJBQXFCO1FBQ3JCLHdDQUF3QztRQUV4Q21CLFNBQVM7WUFDUCxHQUFHQSxNQUFNO1lBQ1RDLE1BQU0sTUFBTUMsUUFBUUMsR0FBRyxDQUNyQkgsT0FBT0MsSUFBSSxDQUFDRyxHQUFHLENBQUMsT0FBT007Z0JBQ3JCLE1BQU1FLFNBQVNGO2dCQUVmLE1BQU1wQyxhQUFhdUMsS0FBSyxDQUFDTixTQUFTLENBQUNPLE1BQU0sQ0FBQyxPQUFPQyxXQUFXQztvQkFDMUQsTUFBTUQ7b0JBRU5ILE9BQU9OLE9BQU8sR0FDWixBQUFDLE1BQU1VLEtBQUs7d0JBQ1ZQLFNBQVMvQixJQUFJK0IsT0FBTzt3QkFDcEJDLEtBQUtBLElBQUlKLE9BQU87d0JBQ2hCSyxVQUFVO3dCQUNWYixRQUFReEI7d0JBQ1IyQyxPQUFPeEI7d0JBQ1BmO29CQUNGLE1BQU9nQyxJQUFJSixPQUFPO2dCQUN0QixHQUFHSixRQUFRZ0IsT0FBTztnQkFFbEIsT0FBT047WUFDVDtRQUVKO1FBRUEsd0NBQXdDO1FBQ3hDLGlCQUFpQjtRQUNqQix3Q0FBd0M7UUFFeENaLFNBQVM7WUFDUCxHQUFHQSxNQUFNO1lBQ1RDLE1BQU1ELE9BQU9DLElBQUksQ0FBQ0csR0FBRyxDQUFDLENBQUNNLE1BQVFTLElBQUFBLCtCQUFzQixFQUFJVDtRQUMzRDtRQUVBLElBQUl4QixjQUFjLE1BQU1rQyxJQUFBQSxvQ0FBaUIsRUFBQzFDO1FBRTFDLE9BQU9zQjtJQUNULEVBQUUsT0FBT3FCLE9BQWdCO1FBQ3ZCLE1BQU1DLElBQUFBLGdDQUFlLEVBQUM1QztRQUN0QixNQUFNMkM7SUFDUjtBQUNGO01BRUEsV0FBZWxEIn0=