/* eslint-disable no-param-reassign */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return registerGraphQLSchema;
    }
});
const _graphql = /*#__PURE__*/ _interop_require_wildcard(require("graphql"));
const _graphqlquerycomplexity = /*#__PURE__*/ _interop_require_wildcard(require("graphql-query-complexity"));
const _access = /*#__PURE__*/ _interop_require_default(require("../auth/graphql/resolvers/access"));
const _init = /*#__PURE__*/ _interop_require_default(require("../collections/graphql/init"));
const _init1 = /*#__PURE__*/ _interop_require_default(require("../globals/graphql/init"));
const _buildFallbackLocaleInputType = /*#__PURE__*/ _interop_require_default(require("./schema/buildFallbackLocaleInputType"));
const _buildLocaleInputType = /*#__PURE__*/ _interop_require_default(require("./schema/buildLocaleInputType"));
const _buildPoliciesType = /*#__PURE__*/ _interop_require_default(require("./schema/buildPoliciesType"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
function _getRequireWildcardCache(nodeInterop) {
    if (typeof WeakMap !== "function") return null;
    var cacheBabelInterop = new WeakMap();
    var cacheNodeInterop = new WeakMap();
    return (_getRequireWildcardCache = function(nodeInterop) {
        return nodeInterop ? cacheNodeInterop : cacheBabelInterop;
    })(nodeInterop);
}
function _interop_require_wildcard(obj, nodeInterop) {
    if (!nodeInterop && obj && obj.__esModule) {
        return obj;
    }
    if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
        return {
            default: obj
        };
    }
    var cache = _getRequireWildcardCache(nodeInterop);
    if (cache && cache.has(obj)) {
        return cache.get(obj);
    }
    var newObj = {};
    var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;
    for(var key in obj){
        if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) {
            var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;
            if (desc && (desc.get || desc.set)) {
                Object.defineProperty(newObj, key, desc);
            } else {
                newObj[key] = obj[key];
            }
        }
    }
    newObj.default = obj;
    if (cache) {
        cache.set(obj, newObj);
    }
    return newObj;
}
function registerGraphQLSchema(payload) {
    payload.types = {
        arrayTypes: {},
        blockInputTypes: {},
        blockTypes: {},
        groupTypes: {},
        tabTypes: {}
    };
    if (payload.config.localization) {
        payload.types.localeInputType = (0, _buildLocaleInputType.default)(payload.config.localization);
        payload.types.fallbackLocaleInputType = (0, _buildFallbackLocaleInputType.default)(payload.config.localization);
    }
    payload.Query = {
        name: 'Query',
        fields: {}
    };
    payload.Mutation = {
        name: 'Mutation',
        fields: {}
    };
    (0, _init.default)(payload);
    (0, _init1.default)(payload);
    payload.Query.fields.Access = {
        resolve: (0, _access.default)(payload),
        type: (0, _buildPoliciesType.default)(payload)
    };
    if (typeof payload.config.graphQL.queries === 'function') {
        const customQueries = payload.config.graphQL.queries(_graphql, payload);
        payload.Query = {
            ...payload.Query,
            fields: {
                ...payload.Query.fields,
                ...customQueries || {}
            }
        };
    }
    if (typeof payload.config.graphQL.mutations === 'function') {
        const customMutations = payload.config.graphQL.mutations(_graphql, payload);
        payload.Mutation = {
            ...payload.Mutation,
            fields: {
                ...payload.Mutation.fields,
                ...customMutations || {}
            }
        };
    }
    const query = new _graphql.GraphQLObjectType(payload.Query);
    const mutation = new _graphql.GraphQLObjectType(payload.Mutation);
    const schema = {
        mutation,
        query
    };
    payload.schema = new _graphql.GraphQLSchema(schema);
    payload.validationRules = ({ variableValues })=>[
            (0, _graphqlquerycomplexity.default)({
                estimators: [
                    (0, _graphqlquerycomplexity.fieldExtensionsEstimator)(),
                    (0, _graphqlquerycomplexity.simpleEstimator)({
                        defaultComplexity: 1
                    })
                ],
                maximumComplexity: payload.config.graphQL.maxComplexity,
                variables: variableValues
            })
        ];
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ncmFwaHFsL3JlZ2lzdGVyU2NoZW1hLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLXBhcmFtLXJlYXNzaWduICovXG5pbXBvcnQgKiBhcyBHcmFwaFFMIGZyb20gJ2dyYXBocWwnXG5pbXBvcnQgeyBHcmFwaFFMT2JqZWN0VHlwZSwgR3JhcGhRTFNjaGVtYSB9IGZyb20gJ2dyYXBocWwnXG5pbXBvcnQgcXVlcnlDb21wbGV4aXR5LCB7XG4gIGZpZWxkRXh0ZW5zaW9uc0VzdGltYXRvcixcbiAgc2ltcGxlRXN0aW1hdG9yLFxufSBmcm9tICdncmFwaHFsLXF1ZXJ5LWNvbXBsZXhpdHknXG5cbmltcG9ydCB0eXBlIHsgUGF5bG9hZCB9IGZyb20gJy4uL3BheWxvYWQnXG5cbmltcG9ydCBhY2Nlc3NSZXNvbHZlciBmcm9tICcuLi9hdXRoL2dyYXBocWwvcmVzb2x2ZXJzL2FjY2VzcydcbmltcG9ydCBpbml0Q29sbGVjdGlvbnMgZnJvbSAnLi4vY29sbGVjdGlvbnMvZ3JhcGhxbC9pbml0J1xuaW1wb3J0IGluaXRHbG9iYWxzIGZyb20gJy4uL2dsb2JhbHMvZ3JhcGhxbC9pbml0J1xuaW1wb3J0IGJ1aWxkRmFsbGJhY2tMb2NhbGVJbnB1dFR5cGUgZnJvbSAnLi9zY2hlbWEvYnVpbGRGYWxsYmFja0xvY2FsZUlucHV0VHlwZSdcbmltcG9ydCBidWlsZExvY2FsZUlucHV0VHlwZSBmcm9tICcuL3NjaGVtYS9idWlsZExvY2FsZUlucHV0VHlwZSdcbmltcG9ydCBidWlsZFBvbGljaWVzVHlwZSBmcm9tICcuL3NjaGVtYS9idWlsZFBvbGljaWVzVHlwZSdcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gcmVnaXN0ZXJHcmFwaFFMU2NoZW1hKHBheWxvYWQ6IFBheWxvYWQpOiB2b2lkIHtcbiAgcGF5bG9hZC50eXBlcyA9IHtcbiAgICBhcnJheVR5cGVzOiB7fSxcbiAgICBibG9ja0lucHV0VHlwZXM6IHt9LFxuICAgIGJsb2NrVHlwZXM6IHt9LFxuICAgIGdyb3VwVHlwZXM6IHt9LFxuICAgIHRhYlR5cGVzOiB7fSxcbiAgfVxuXG4gIGlmIChwYXlsb2FkLmNvbmZpZy5sb2NhbGl6YXRpb24pIHtcbiAgICBwYXlsb2FkLnR5cGVzLmxvY2FsZUlucHV0VHlwZSA9IGJ1aWxkTG9jYWxlSW5wdXRUeXBlKHBheWxvYWQuY29uZmlnLmxvY2FsaXphdGlvbilcbiAgICBwYXlsb2FkLnR5cGVzLmZhbGxiYWNrTG9jYWxlSW5wdXRUeXBlID0gYnVpbGRGYWxsYmFja0xvY2FsZUlucHV0VHlwZShcbiAgICAgIHBheWxvYWQuY29uZmlnLmxvY2FsaXphdGlvbixcbiAgICApXG4gIH1cblxuICBwYXlsb2FkLlF1ZXJ5ID0ge1xuICAgIG5hbWU6ICdRdWVyeScsXG4gICAgZmllbGRzOiB7fSxcbiAgfVxuXG4gIHBheWxvYWQuTXV0YXRpb24gPSB7XG4gICAgbmFtZTogJ011dGF0aW9uJyxcbiAgICBmaWVsZHM6IHt9LFxuICB9XG5cbiAgaW5pdENvbGxlY3Rpb25zKHBheWxvYWQpXG4gIGluaXRHbG9iYWxzKHBheWxvYWQpXG5cbiAgcGF5bG9hZC5RdWVyeS5maWVsZHMuQWNjZXNzID0ge1xuICAgIHJlc29sdmU6IGFjY2Vzc1Jlc29sdmVyKHBheWxvYWQpLFxuICAgIHR5cGU6IGJ1aWxkUG9saWNpZXNUeXBlKHBheWxvYWQpLFxuICB9XG5cbiAgaWYgKHR5cGVvZiBwYXlsb2FkLmNvbmZpZy5ncmFwaFFMLnF1ZXJpZXMgPT09ICdmdW5jdGlvbicpIHtcbiAgICBjb25zdCBjdXN0b21RdWVyaWVzID0gcGF5bG9hZC5jb25maWcuZ3JhcGhRTC5xdWVyaWVzKEdyYXBoUUwsIHBheWxvYWQpXG4gICAgcGF5bG9hZC5RdWVyeSA9IHtcbiAgICAgIC4uLnBheWxvYWQuUXVlcnksXG4gICAgICBmaWVsZHM6IHtcbiAgICAgICAgLi4ucGF5bG9hZC5RdWVyeS5maWVsZHMsXG4gICAgICAgIC4uLihjdXN0b21RdWVyaWVzIHx8IHt9KSxcbiAgICAgIH0sXG4gICAgfVxuICB9XG5cbiAgaWYgKHR5cGVvZiBwYXlsb2FkLmNvbmZpZy5ncmFwaFFMLm11dGF0aW9ucyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIGNvbnN0IGN1c3RvbU11dGF0aW9ucyA9IHBheWxvYWQuY29uZmlnLmdyYXBoUUwubXV0YXRpb25zKEdyYXBoUUwsIHBheWxvYWQpXG4gICAgcGF5bG9hZC5NdXRhdGlvbiA9IHtcbiAgICAgIC4uLnBheWxvYWQuTXV0YXRpb24sXG4gICAgICBmaWVsZHM6IHtcbiAgICAgICAgLi4ucGF5bG9hZC5NdXRhdGlvbi5maWVsZHMsXG4gICAgICAgIC4uLihjdXN0b21NdXRhdGlvbnMgfHwge30pLFxuICAgICAgfSxcbiAgICB9XG4gIH1cblxuICBjb25zdCBxdWVyeSA9IG5ldyBHcmFwaFFMT2JqZWN0VHlwZShwYXlsb2FkLlF1ZXJ5KVxuICBjb25zdCBtdXRhdGlvbiA9IG5ldyBHcmFwaFFMT2JqZWN0VHlwZShwYXlsb2FkLk11dGF0aW9uKVxuXG4gIGNvbnN0IHNjaGVtYSA9IHtcbiAgICBtdXRhdGlvbixcbiAgICBxdWVyeSxcbiAgfVxuXG4gIHBheWxvYWQuc2NoZW1hID0gbmV3IEdyYXBoUUxTY2hlbWEoc2NoZW1hKVxuXG4gIHBheWxvYWQudmFsaWRhdGlvblJ1bGVzID0gKHsgdmFyaWFibGVWYWx1ZXMgfSkgPT4gW1xuICAgIHF1ZXJ5Q29tcGxleGl0eSh7XG4gICAgICBlc3RpbWF0b3JzOiBbXG4gICAgICAgIGZpZWxkRXh0ZW5zaW9uc0VzdGltYXRvcigpLFxuICAgICAgICBzaW1wbGVFc3RpbWF0b3IoeyBkZWZhdWx0Q29tcGxleGl0eTogMSB9KSwgLy8gRmFsbGJhY2sgaWYgY29tcGxleGl0eSBub3Qgc2V0XG4gICAgICBdLFxuICAgICAgbWF4aW11bUNvbXBsZXhpdHk6IHBheWxvYWQuY29uZmlnLmdyYXBoUUwubWF4Q29tcGxleGl0eSxcbiAgICAgIHZhcmlhYmxlczogdmFyaWFibGVWYWx1ZXMsXG4gICAgICAvLyBvbkNvbXBsZXRlOiAoY29tcGxleGl0eSkgPT4geyBjb25zb2xlLmxvZygnUXVlcnkgQ29tcGxleGl0eTonLCBjb21wbGV4aXR5KTsgfSxcbiAgICB9KSxcbiAgXVxufVxuIl0sIm5hbWVzIjpbInJlZ2lzdGVyR3JhcGhRTFNjaGVtYSIsInBheWxvYWQiLCJ0eXBlcyIsImFycmF5VHlwZXMiLCJibG9ja0lucHV0VHlwZXMiLCJibG9ja1R5cGVzIiwiZ3JvdXBUeXBlcyIsInRhYlR5cGVzIiwiY29uZmlnIiwibG9jYWxpemF0aW9uIiwibG9jYWxlSW5wdXRUeXBlIiwiYnVpbGRMb2NhbGVJbnB1dFR5cGUiLCJmYWxsYmFja0xvY2FsZUlucHV0VHlwZSIsImJ1aWxkRmFsbGJhY2tMb2NhbGVJbnB1dFR5cGUiLCJRdWVyeSIsIm5hbWUiLCJmaWVsZHMiLCJNdXRhdGlvbiIsImluaXRDb2xsZWN0aW9ucyIsImluaXRHbG9iYWxzIiwiQWNjZXNzIiwicmVzb2x2ZSIsImFjY2Vzc1Jlc29sdmVyIiwidHlwZSIsImJ1aWxkUG9saWNpZXNUeXBlIiwiZ3JhcGhRTCIsInF1ZXJpZXMiLCJjdXN0b21RdWVyaWVzIiwiR3JhcGhRTCIsIm11dGF0aW9ucyIsImN1c3RvbU11dGF0aW9ucyIsInF1ZXJ5IiwiR3JhcGhRTE9iamVjdFR5cGUiLCJtdXRhdGlvbiIsInNjaGVtYSIsIkdyYXBoUUxTY2hlbWEiLCJ2YWxpZGF0aW9uUnVsZXMiLCJ2YXJpYWJsZVZhbHVlcyIsInF1ZXJ5Q29tcGxleGl0eSIsImVzdGltYXRvcnMiLCJmaWVsZEV4dGVuc2lvbnNFc3RpbWF0b3IiLCJzaW1wbGVFc3RpbWF0b3IiLCJkZWZhdWx0Q29tcGxleGl0eSIsIm1heGltdW1Db21wbGV4aXR5IiwibWF4Q29tcGxleGl0eSIsInZhcmlhYmxlcyJdLCJtYXBwaW5ncyI6IkFBQUEsb0NBQW9DOzs7OytCQWlCcEM7OztlQUF3QkE7OztpRUFoQkM7Z0ZBS2xCOytEQUlvQjs2REFDQzs4REFDSjtxRkFDaUI7NkVBQ1I7MEVBQ0g7Ozs7Ozs7Ozs7Ozs7Ozs7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